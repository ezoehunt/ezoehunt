<?php
/**
* @package ehtheme
*
* Based on Twentyseventeen Wordpress theme
*
* Theme Functions
*
*/

function ehtheme_setup() {
	/*
  * TODO - if rss doesnt show up correctly in head, turn this on and delete manual stuff from head
  */
	//add_theme_support( 'automatic-feed-links' );
  /* --- Add featured image to posts --- */
  add_theme_support( 'post-thumbnails' );
  add_theme_support( 'post-formats', array( 'aside' ) );
  add_post_type_support( 'post', 'post-formats' );
  add_post_type_support( 'page', 'post-formats' );
  /* --- No idea --- */
	add_image_size( 'ehtheme-featured-image', 2000, 1200, true );
	add_image_size( 'ehtheme-thumbnail-avatar', 100, 100, true );

	/* --- No idea --- */
  add_theme_support( 'html5', array(
		'comment-form',
		'comment-list',
		'gallery',
		'caption',
	) );
}
add_action( 'after_setup_theme', 'ehtheme_setup' );


/* --- Remove empty Paragraphs in the_content that are auto generated by Wordpress --- */
remove_filter( 'the_content', 'wpautop' );


/* --- Remove admin bar from front-end site --- */
add_filter('show_admin_bar', '__return_false');


/* --- Update Admin CSS --- */
function admin_style() {
  wp_enqueue_style('admin-styles', get_template_directory_uri().'/admin_eztheme.css');
}
add_action('admin_enqueue_scripts', 'admin_style');



// CREATE MAILTO SHORTCODE = [myemail]
function email_encode_function( $atts, $content ) {
  return antispambot($content);
}
add_shortcode( 'myemail', 'email_encode_function' );



// CREATE IMAGE ALT SHORTCODE = [myimagealt]
// [myimagealt attach_id="valueA" type="valueB"]
function my_image_alt_function( $attr ) {
  extract(shortcode_atts(array(
    'attach_id' => 'something more',
    'type'      => 'something else'
  ), $attr ));
  $parent_id = get_post_ancestors( $attr['attach_id'] );

  $getattach = get_post_meta($parent_id[0], '_blog_images');
  $attachments = $getattach[0];

  foreach ( $attachments as $image ) {
    $newID = $image['_blog_image_images'][0];
    if ( $newID == $attr['attach_id'] ) {
      if (!empty ( $image['_blog_image_alt'] ) ) {
        $image_alt = $image['_blog_image_alt'];
      }
      if (!empty ( $image['_blog_image_title'] ) ) {
        $image_title = $image['_blog_image_title'];
      }
    }
  }
  if ( $attr['type'] == 'title' ) {
    return 'title="'.$image_title.'"';
  }
  if ( $attr['type'] == 'alt' ) {
    return 'alt="'.$image_alt.'"';
  }
}
add_shortcode( 'myimagealt', 'my_image_alt_function' );



// CREATE CUSTOM CAPTION SHORTCODE FOR POSTS + PAGES
// Does not apply to Custom Post Types
add_shortcode('mycaption', 'eh_caption');
function eh_caption($attr, $content = NUll ) {

  extract(shortcode_atts(array(
    'id'	    => '',
    'align'	  => '',
    'caption' => '',
    'class'   => ''
  ), $attr));

  // Set up
  preg_match('/\d+/', $id, $att_id);
  if ( $id ) {
    $id = 'id="' . esc_attr($id) . '" ';
  }

  if ( !empty( $attr['caption'] ) && $attr['caption'] == 'no' ) {
    return '<div ' . $id . 'class="wp-caption '. esc_attr($class) . ' ' . esc_attr($align) . '">' . do_shortcode( $content ) . '</div>';
  }

  if ( !empty( $attr['caption'] ) && $attr['caption'] == 'yes') {
    $parent_id = get_post_ancestors( $att_id[0] );
    $parent_cat_slug = eh_get_cat_slug($parent_id[0]);
    $href_class = $parent_cat_slug;

    $getattach = get_post_meta($parent_id[0], '_blog_images');
    $attachments = $getattach[0];

    foreach ( $attachments as $image ) {
      $newID = $image['_blog_image_images'][0];

      if ( $newID == $att_id[0] ) {
        /*if (!empty ( $image['_blog_image_title'] ) ) {
          $image_title = $image['_blog_image_title'];
        }
        if (!empty ( $image['_blog_image_alt'] ) ) {
          $image_alt = $image['_blog_image_alt'];
        }*/
        if (!empty ( $image['_blog_image_caption'] ) ) {
          $image_caption = $image['_blog_image_caption'];
          $image_caption = str_replace('|', '<br/>', $image_caption);
        }
        if (!empty ( $image['_blog_image_attr_name'] ) ) {
          $image_attr_name = $image['_blog_image_attr_name'];
        }
        if (!empty ( $image['_blog_image_attr_url'] ) ) {
          $image_attr_url = $image['_blog_image_attr_url'];
        }
        if ( is_numeric($att_id[0]) && !empty( $image_attr_url ) ) {
      		$image_caption .= '<br/>(attr: <a class="'.$href_class.'" title="View orginal image" target="_blank" href="'.$image_attr_url.'">'.$image_attr_name.'</a>)';
      	}
        elseif ( is_numeric($att_id[0]) && empty( $image_attr_url ) && !empty( $image_attr_name) ) {
          $image_caption .= '<br/>(attr: '.$image_attr_name.')';
        }

        return '<div ' . $id . 'class="wp-caption '. esc_attr($class) . ' ' . esc_attr($align) . '">' . do_shortcode( $content ) . '<p class="wp-caption-text">' . $image_caption . '</p></div>';
      }
    }
  }
  /*
  if ($attr['caption'] == 'yes' && $att_id[0] == $newID ) {

    if (!empty ( $attachments[0][0]['_blog_image_title'] ) ) {
      $image_title = $attachments[0][0]['_blog_image_title'];
    }
    if (!empty ( $attachments[0][0]['_blog_image_alt'] ) ) {
      $image_alt = $attachments[0][0]['_blog_image_alt'];
    }
    if (!empty ( $attachments[0][0]['_blog_image_caption'] ) ) {
      $image_caption = $attachments[0][0]['_blog_image_caption'];
    }
    if (!empty ( $attachments[0][0]['_blog_image_attr_name'] ) ) {
      $image_attr_name = $attachments[0][0]['_blog_image_attr_name'];
    }
    if (!empty ( $attachments[0][0]['_blog_image_attr_url'] ) ) {
      $image_attr_url = $attachments[0][0]['_blog_image_attr_url'];
    }

    if ( is_numeric($att_id[0]) && !empty( $image_attr_url ) ) {
  		$image_caption .= '<br/>(attr: <a class="'.$href_class.'" title="View orginal image" target="_blank" href="'.$image_attr_url.'" target="">'.$image_attr_name.'</a>)';
  	}
    elseif ( is_numeric($att_id[0]) && empty( $image_attr_url ) && !empty( $image_attr_name) ) {
      $image_caption .= '<br/>(attr: '.$image_attr_name.')';
    }
    return '<div ' . $id . 'class="wp-caption '. esc_attr($class) . ' ' . esc_attr($align) . '">' . do_shortcode( $content ) . '<p class="wp-caption-text">' . $image_caption . '</p></div>';
  }
  //if ($attr['caption'] == 'yes' && $att_id[0] == $newID ) {
  elseif ($attr['caption'] == 'no') {
    return '<div ' . $id . 'class="wp-caption '. esc_attr($class) . ' ' . esc_attr($align) . '">' . do_shortcode( $content ) . '</div>';
  }
  */
}





// ADD CATEGORIES TO BODYCLASS FOR SINGLE POSTS
/* -- Needed to use bodyclass to indicate "active" state in nav for all posts. By default Wordpress doesn't include category name for Single Posts in bodyclass -- */
add_filter('body_class','add_category_to_single');
function add_category_to_single($classes) {
  if (is_single() ) {
    global $post;
    foreach((get_the_category($post->ID)) as $category) {
      // add category slug to the $classes array
      $classes[] = $category->category_nicename;
    }
  }
  // return the $classes array
  return $classes;
}



// CREATE NEW CUSTOM POST TYPE = PROJECT
function create_project_post_type() {
  // post type name shown in URL, eg /work/post-1
	register_post_type( 'work',
		array(
			'labels' => array(
				'name' => 'Portfolio',
				'singular_name' => 'Project',
				'add_new' => 'Add New',
				'add_new_item' => 'Add New Project',
				'edit_item' => 'Edit Project',
				'new_item' => 'New Project',
				'view_item' => 'View Project',
				'search_items' => 'Search Projects',
				'not_found' =>  'Nothing Found',
				'not_found_in_trash' => 'Nothing found in the Trash',
				'parent_item_colon' => ''
			),
			'public' => true,
      'has_archive' => true,
      'publicly_queryable' => true,
			'show_ui' => true,
			'query_var' => true,
			'rewrite' => true,
			'capability_type' => 'post',
			'hierarchical' => false,
			'menu_position' => null,
			'supports' => array('title','editor','thumbnail','author','thumbnail','excerpt','custom-fields', 'aside'),
      'taxonomies'  => array( 'category' ),
		)
	);
}
add_action( 'init', 'create_project_post_type' );



// CREATE CUSTOM TAXONOMY FOR CUSTOM POST TYPE = PROJECT
/* Use to indicate which posts to show on home page with tag = featured */
register_taxonomy("project_tags", array("work"), array(
	"hierarchical" => false,
	"label" => "Project Tags",
	"singular_label" => "Project Tag",
	"rewrite" => true
));



// INLCUDE REGISTER METABOXES FOR CUSTOM POST TYPE = PROJECT
include '_portfolio-details.php';



/* --- Add Post Tags to Attachment Post Type -- */
function eh_add_tags_to_attachments() {
  register_taxonomy_for_object_type( 'post_tag', 'attachment' );
}
add_action( 'init' , 'eh_add_tags_to_attachments' );



// ADD META BOXES TO REGULAR POSTS + PAGES
function eh_register_meta_boxes_posts( $meta_boxes ) {
  $prefix = '_blog_';
  $meta_boxes[] = array(
    'title'      => __( 'Post Details', 'textdomain' ),
    'post_types' => array( 'post', 'page' ),
    'context'    => 'normal',
    'priority'   => 'high',
    'fields' => array(
      array(
          'name'  => __( 'Post Headline', 'textdomain' ),
          'desc'  => 'The Post Headline appears in magazine header area.',
          'id'    => $prefix . 'headline',
          'type'  => 'text',
          'clone' => false,
      ),
      array(
          'name'  => __( 'Post Subhead', 'textdomain' ),
          'desc'  => 'The Post Subhead appears in the body copy aera.',
          'id'    => $prefix . 'subhead',
          'type'  => 'text',
          'clone' => false,
      )
    )
  );
  $meta_boxes[] = array(
    'title'      => __( 'Image Details', 'textdomain' ),
    'post_types' => array( 'post', 'page' ),
    'context'    => 'normal',
    'priority'   => 'high',
    'fields' => array(
      array(
				'id'     => $prefix.'images',
				// Group field
				'type'   => 'group',
				// Clone whole group?
				'clone'  => true,
				// Drag and drop clones to reorder them?
				'sort_clone' => true,
				// Sub-fields
				'fields' => array(
          array(
						'id'      => $prefix.'image_title',
            'name'    => __( 'Image Title', 'rwmb' ),
						'type'    => 'text',
            'class'  => 'ez-admin-text'
					),
          array(
						'id'      => $prefix.'image_alt',
            'name'    => __( 'Image Alt Text', 'rwmb' ),
						'type'    => 'text',
            'class'  => 'ez-admin-text'
					),
          array(
						'id'      => $prefix.'image_caption',
            'name'    => __( 'Image Caption', 'rwmb' ),
						'type'    => 'textarea',
            'class'  => 'ez-admin-textarea'
					),
          array(
            'id'    => $prefix . 'image_attr_name',
            'name'  => __( 'Attribution Name', 'textdomain' ),
            'type'  => 'text',
            'class' => 'ez-admin-text'
          ),
          array(
            'id'    => $prefix . 'image_attr_url',
            'name'  => __( 'Attribution URL', 'textdomain' ),
            'type'  => 'text',
            'class' => 'ez-admin-text'
          ),
          array(
    				'id'      => $prefix.'image_images',
            'name'    => esc_html__( 'Image', 'rwmb' ),
    				'type'    => 'image_advanced',
            'class'  => 'ez-admin-imginput',

    				// Delete image from Media Library when remove it from post meta? Note: it might affect other posts if you use same image for multiple posts
    				'force_delete'     => false,

    				// Maximum image uploads PER CLONED PART
    				'max_file_uploads' => 1,

    				// Display the "Uploaded 1/2 files" status
    				'max_status'       => true,
    			)
				)
			)
    )
  );
  return $meta_boxes;
}
add_filter( 'rwmb_meta_boxes', 'eh_register_meta_boxes_posts' );




// MISC FUNCTIONS

function eh_sluggify($string) {
  # Prep string with some basic normalization
  $string = strtolower($string);
  $string = strip_tags($string);
  $string = stripslashes($string);
  $string = html_entity_decode($string);

  # Remove quotes (can't, etc.)
  $string = str_replace('\'', '', $string);

  # Replace non-alpha numeric with hyphens
  $match = '/[^a-z0-9]+/';
  $replace = '-';
  $string = preg_replace($match, $replace, $string);

  $string = trim($string, '-');

  return $string;
}


function eh_get_cat_name($post_id) {
  $post_categories = wp_get_post_categories( $post_id );
  $cats = array();
  foreach ( $post_categories as $c ) {
    $cat = get_category( $c );
    $cat_name = $cat->name;
  }
  return $cat_name;
}


function eh_get_cat_slug($post_id) {
  $post_categories = wp_get_post_categories( $post_id );
  $cats = array();
  foreach ( $post_categories as $c ) {
    $cat = get_category( $c );
    $cat_slug = $cat->slug;
  }
  return $cat_slug;
}


function eh_get_image_id($image_url) {
	global $wpdb;
	$attachment = $wpdb->get_col($wpdb->prepare("SELECT ID FROM $wpdb->posts WHERE guid='%s';", $image_url ));
  return $attachment;
}


// For Page to Page navigation
function eh_next_previous( $post_id, $type, $cat_slug ) {
  // Adjust output
  if ( $cat_slug == 'work' ) {
    $cat_alt = $type.' Porfolio project';
  }
  if ( $cat_slug == 'words' ) {
    $cat_alt = $type.' post in Words';
  }
  // Get next/previous in the same category
  // Match type to icons + function
  if ( $type == 'previous' ) {
    $function = get_previous_post(true,'');
    $icon = '<span class="fa fa-stack"><i class="fa fa-circle fa-stack-1x icon-a icon-bg-'.$cat_slug.'" aria-hidden="true"></i><i class="fa fa-arrow-left fa-stack-1x icon-b icon-color-inverse" aria-hidden="true"></i></span>';
  }
  elseif ( $type == 'next' ) {
    $function = get_next_post(true,'');
    $icon = '<span class="fa fa-stack"><i class="fa fa-circle fa-stack-1x icon-a icon-bg-'.$cat_slug.'" aria-hidden="true"></i><i class="fa fa-arrow-right fa-stack-1x icon-b icon-color-inverse" aria-hidden="true"></i></span>';

  }
  // If none, return false (empty)
  if( $function ) {
    return '<a class="" title="See '.$cat_alt.'" href="'.esc_url(get_permalink($function->ID)).'">'.$icon.'</a>';
  }
  else {
    return false;
  }
}


// For Attachment to Attachment Navigation
function eh_nextprev_img_link( $post_id, $array, $type, $cat_slug, $count ) {

  if ( $count === 1 ) {
    return false;
  }
  // Zero index count
  $count = $count-1;
  $currentkey = array_search($post_id, $array);

  if ( $currentkey != 0 ) {
    $prevID = $array[$currentkey-1];
  }
  if ( $currentkey != $count ) {
    $nextID = $array[$currentkey+1];
  }

  if ( !empty( $prevID ) && $type == 'previous' ) {
    $link = get_attachment_link($prevID);
    $icon = '<span class="fa fa-stack"><i class="fa fa-circle fa-stack-1x icon-a icon-bg-'.$cat_slug.'" aria-hidden="true"></i><i class="fa fa-arrow-left fa-stack-1x icon-b icon-color-inverse" aria-hidden="true"></i></span>';
  }
  elseif ( !empty( $nextID ) && $type == 'next' ) {
    $link = get_attachment_link($nextID);
    $icon = '<span class="fa fa-stack"><i class="fa fa-circle fa-stack-1x icon-a icon-bg-'.$cat_slug.'" aria-hidden="true"></i><i class="fa fa-arrow-right fa-stack-1x icon-b icon-color-inverse" aria-hidden="true"></i></span>';
  }

  if( !empty( $link ) ) {
    return '<a class="'.$cat_slug.'" title="See '.$type.' image" href="'.esc_url($link).'">'.$icon.'</a>';
  }
  else {
    return false;
  }
}


function eh_paginate($query) {
  $big = 999999999;
  $translated = __( 'Page', 'mytextdomain' );

  return paginate_links( array (
  	'base' => str_replace( $big, '%#%', esc_url( get_pagenum_link( $big ) ) ),
  	'format'    => '?paged=%#%',
    'end_size'  => 1,
    'mid_size'  => 1,
    'prev_next' => true,
  	'prev_text' => __('&laquo;'),
  	'next_text' => __('&raquo;'),
  	'current'   => max( 1, get_query_var('paged') ),
  	'total'     => $query->max_num_pages,
    'before_page_number' => '<span class="screen-reader-text">'.$translated.' </span>'
    ) );
}


// NOT USING
function eh_break_text($text){
    $length = 500;
    //don't cut if too short
    if(strlen($text)<$length+10) return $text;
    //find next space after desired length
    $break_pos = strpos($text, ' ', $length);
    $visible = substr($text, 0, $break_pos);
    return balanceTags($visible) . " [â€¦]";
}
